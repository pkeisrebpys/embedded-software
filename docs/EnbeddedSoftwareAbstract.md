# 組み込みソフトウェアの動作
組み込みソフトウェアを実行する演算装置の構成と定常時の動作を説明する。
また，電源投入から定常動作を開始するまでの起動処理について説明する。

C言語のプログラムはメモリの操作など演算装置の動作に近い記述ができる。
演算装置の動作をイメージできる方が，プログラムを理解しやすい。
また，演算速度，メモリ容量を改善する上でも動作のイメージがあると役立つ。

## 演算装置の構成
演算装置の主要な構成要素は以下。

- 演算装置 プログラムに書かれた命令に応じ，データに対して操作を行う。
- レジスタ 演算装置で使うデータを一時的に保存する。保存容量は小さいが高速動作。
- メモリ データを保存する。レジスタより大容量だが低速。
- キャッシュ 動作速度，容量ともにレジスタとメモリの中間の性能を持ち，レジスタとメモリの間でデータを一時的に保存する。キャッシュがない場合もある。

演算装置・レジスタ・メモリは動作を理解する上で必須である。
より正確な動作を理解するにはキャッシュを含める必要があるが，
最低限の理解にはキャッシュがない構成でよい。

## 演算装置の定常動作
演算装置の動作の流れは以下。

1. 命令の読み込み
2. 命令の解釈
3. 命令の実行
4. 実行結果の格納

演算装置の個々の命令動作について把握するには演算装置の命令セットを調べると良い。
アセンブラ言語で書かれたコードを読むことも演算装置動作の理解を助ける。

以降で，各動作段階を説明する。

### 命令の読み込み
通常のデータと同じく，演算装置への命令もメモリに保存されている。
次に実行する命令をメモリから読み込む。
読み込む命令が保存されたメモリアドレスは，
プログラムカウンタと呼ばれる特別なレジスタに保存されている。
プログラムカウンタに示されたアドレスから演算装置に命令を読み込む。
プログラムカウンタは次の命令読み込みに備えて1命令のデータサイズ分だけ加算される。

### 命令の解釈
演算装置への命令は以下の2つの部分から構成される。
- オペコード 何の操作をするのかを示す
- オペランド 操作に必要なデータ，レジスタ位置，アドレスなどを示す

演算装置は命令を解釈し，必要に応じてデータをレジスタから読み込む準備をする。
演算に備えて使用する演算回路を選択する。

### 命令の実行
レジスタからデータを読み込み，命令に従った処理を行う。
処理は1クロックで完了するものもあれば，
完了までに複数クロックを要するものもある。

### 実行結果の格納
演算処理によって得られたデータを命令で指定されたレジスタに格納する。

## メモリ入出力
演算装置動作の基本はレジスタからデータを読み込み，処理し，再びレジスタに格納する流れである。
この流れだけでは小容量のレジスタだけを使って演算することになり，
大量のデータを使った演算ができない。

これを解決するために，演算装置の命令には大容量のメモリからレジスタにデータを読み込み，
逆にレジスタに保存された演算結果をメモリに書き出すものがある。

演算においてメモリ上のデータが必要になるとメモリからデータを読み込む命令が実行される。
この命令はメモリアドレスを指定し，そのアドレスのデータをレジスタに保存する。
メモリはレジスタに比べて低速動作であるから，
この命令実行には時間を要する。
メモリからのデータ読み込みのたびに待たされては演算時間が増加してしまう。
これを解決するためにキャッシュが用いられる。詳細は省略する。

レジスタに読み込まれたデータで演算が行われ，結果がレジスタに保存されると，
今度はレジスタからメモリへデータを書き出す命令が実行される。
この命令も書き出す先のメモリアドレスを指定して実行される。
メモリへのデータ書き出しも読み込み同様に時間を要する。
書き出しに関してもキャッシュを用いるなど，演算時間短縮の方策が取られている。

## 外部入出力
これまでの説明で，メモリからデータを読み込み，
レジスタに格納し，演算を実行し，結果をレジスタに格納したあと，
適宜メモリに結果を書き出すという演算の基本的な流れをみてきた。
ここまでの流れだけではデータは演算装置内部でのみ循環しており，
実際に制御したい外部装置とのデータのやりとりができないように見える。

実はこれまでの説明の流れで，外部入出力も実現できる。
演算装置からの外部入出力は
メモリに割り当てられていないアドレスへのデータ入出力として実現される。

例えばメモリアドレスが 16 bit，メモリ容量が 32 KB であったとする。
16 bit のアドレスでは 0 から 65535 まで表現できる。
メモリにはこのうち 0 から 32767 までを割り当てたとする。

メモリアドレス 0 から 32767 までにアクセスした場合，
データはメモリとレジスタの間でやり取りされる。

32768 から 65535 までの範囲へのアクセスはメモリに割り当てられておらず，
空いている。
このアドレスに外部機器への入出力を割り当てる。

例えば AD 変換器を利用する場合，AD 変換結果の値をチャンネル数分取得したい。
AD 変換結果が 1 チャンネルあたり 1 byte のデータであり，8 チャンネルあったとする。
合計で 8 byte のデータを取り出せれば良い。
AD 変換器からのデータ取得のために
32768 から32775 までの 8 byte のアドレスをチャンネル 1 から 8 の順番に
割り当てたとする。
この場合，アドレス 32768 をメモリだと思って読むとチャンネル 1 の AD 変換結果が得られる。
以降同様にして 32775 からはチャンネル 8 の AD 変換結果が得られる。

このように接続したい外部機器に空いているアドレスを割り振ることで，
演算装置からはメモリにアクセスしているように見せかけて外部機器への入出力を実現する。

アドレスに余裕がある場合は，接続する外部機器全てにアドレスを割り振る事ができる。
接続機器が増え，個々のデータサイズも大きくなると，
必要な入出力全てにアドレスを割り振ることができなくなる。
このような場合には，バンク切り替えという方法を用いる。

バンク切り替えでは外部機器に与えられたアドレスの一部を用いて，
メモリアドレスと外部機器の接続先を切り替える。

例えば外部機器が 8192 byte の入出力を必要としているが，
割り当てられたアドレスは 33 byte だけであったとする。
この場合割り当てられたアドレスのうち， 32 byte を実際のデータ入出力のために用い，
1 byte のデータで割当アドレスと機器上のデータとの対応関係を切り替える。
1 byte のデータでは 256 通りの対応関係が表現でき，
実際に存在する 32 byte の入出力を 256 倍してちょうど 8192 byte の入出力が可能となる。

例えば切り替え用アドレスのデータが 0 の場合，
外部機器の 0 から 31 byte を参照できる。
切り替え用アドレスのデータが 1 の場合，
外部機器の 32 から 63 byte を参照できる。
以降，切り替えアドレスのデータに応じて外部機器の参照位置がずれていく。

このバンク切り替えの考え方は外部機器の見える範囲が切り替わっていくと考えてもよいが，
切り替え用アドレスのデータで外部機器上のアドレスを表現しているとも考えられる。

与えられたデータ入出力用のメモリアドレスは 32 byte であり 5 bit のアドレスに相当する。
これに対し，外部機器は 8192 byte の入出力があり，
アドレスを表現するには 13 bit 必要である。
この 13 bit のアドレスを表現するため，
下位 5 bit はデータ入出力用のメモリアドレス値，
上位 8 bit は切り替えアドレスのデータ 8 bit をあわせて一つのアドレスとしてアクセスしていると考えることができる。

このように下位アドレスは実際にメモリアドレス上に配置し，
上位アドレスはデータとして与える方式はキャッシュをはじめよく見られる。

## ソフトウェア起動時の動作
ここまで，ソフトウェアが立ち上がった後の定常動作を見てきた。
実際のソフトウェア動作では，
組み込み機器に電源が投入されてから，
定常動作に入るまで以下の手順が必要となる。

1. 演算装置・周辺装置への供給電圧が安定するまで待機する
2. ソフトウェアが保存されている領域を探し出す
2. 保存されていたソフトウェアを演算装置のメモリに読み込む
3. ソフトウェア開始位置に演算装置のプログラムカウンタを合わせる
4. ソフトウェアが起動し，メモリや周辺装置の初期化，割り込み設定を行う
5. 割り込みを有効化し，定常動作に入る

供給電圧が安定するまで待機する時点ではソフトウェアが起動していない。
このため電圧の判定などをソフトウェアで実施することはできない。
この動作を実現するためにはリセット IC を用いる。
リセット IC は電源電圧を監視し，
低電圧時には演算装置・周辺装置のリセット端子をリセット状態に保持する。
リセット状態は多くの場合，端子電圧を low に落とすことで実現される。
電源電圧が十分に上昇するとリセット状態を解除する。
リセット IC を利用することで，電源投入直後の電圧が不安定な状態で，
演算装置・周辺装置が異常な動作をすることを防ぐことができる。

リセットが解除された直後の演算装置のメモリにはソフトウェアが存在しない。
ソフトウェアが存在しなければ演算装置は動作できないため，
メモリ上にソフトウェアを読み込むことすらできない。
ソフトウェアの起動にはソフトウェアが必要であるという，
卵が先か，鶏が先か状態を解決する必要がある。

このため，
ソフトウェアを読み込むためのソフトウェアを演算装置に送り込む機能が，
演算装置もしくは周辺装置として用意されている。
この機能は外部記憶装置
(パーソナルコンピュータであればハードディスクなど，
組み込み機器であれば ROM IC など)
の予め指定された領域から指定されたサイズのデータを
演算装置の指定されたメモリ領域にコピーする。
そしてコピーしたデータをプログラムとして実行するよう演算装置を設定する。
この機能では，
外部記憶装置からメモリにデータをコピーするだけという単純・単一の動作しかできない。
この小さなプログラムからより大きなプログラムを次々に読み込むことで起動処理が実現される。

外部記憶装置から読みこまれたプログラムは，
最初のプログラムよりは規模が大きく複雑なことが可能となっている。
このプログラムも基本的には次のプログラムを読み込むことが主な動作である。
先程とは異なり，次のプログラムのデータ位置とサイズをある程度自由に選択して読み込むことができる。
この自由度によって実現したい機能によって変化するプログラムサイズや保存場所に対応する。
このプログラムも次のプログラムを読み込むと，演算装置が次のプログラムを実行できるよう，プログラムカウンタを設定する。

このようなプログラムがプログラムを次々に読み込み，実行していくことを繰り返し，
最終的に実行したいプログラムが読みこまれ，実行される。
最終的なプログラムでは演算に必要なメモリを確保，初期化したり，周辺装置の設定を行ったり，
割り込み条件，優先度を設定したりする。

最終的に割り込みを受け付ける設定を行い，定常動作に移る。

